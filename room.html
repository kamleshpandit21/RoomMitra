<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dynamic Room Listing Form</title>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.1.0/css/adminlte.min.css"
  />
  <style>
    body {
      background-color: #f4f6f9;
    }
    .card {
      margin-top: 20px;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .step {
      display: none;
    }
    .step.active {
      display: block;
    }
    .tooltip-inner {
      max-width: 220px;
      text-align: left;
    }
    #photoPreview {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    #photoPreview img {
      width: 100px;
      height: 75px;
      object-fit: cover;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    #formMessage {
      margin-top: 10px;
      color: red;
      font-weight: 600;
    }
    .btn-step {
      min-width: 100px;
    }
    .ml-3 {
      margin-left: 1rem !important;
    }
    /* For spacing checkboxes nicely */
    .form-check {
      margin-bottom: 8px;
    }
  </style>
</head>
<body class="hold-transition sidebar-mini">
  <div class="wrapper">
    <div class="content-wrapper">
      <section class="content">
        <div class="container-fluid">
          <form id="roomListingForm" novalidate autocomplete="off">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Room Listing Form</h3>
              </div>
              <div class="card-body">

                <!-- Step 1: Basic Info -->
                <div class="step active" data-step="1" aria-label="Step 1">
                  <h5 class="mb-4">Step 1: Basic Info</h5>

                  <!-- Room Type -->
                  <div class="form-group">
                    <label for="roomType">Room Type <span class="text-danger">*</span></label>
                    <select
                      class="form-control"
                      id="roomType"
                      required
                      aria-describedby="roomTypeHelp"
                    >
                      <option value="">Select Room Type</option>
                      <option value="private">Private Room</option>
                      <option value="shared">Shared Room</option>
                    </select>
                    <small id="roomTypeHelp" class="form-text text-muted"
                      >Select the type of room.</small
                    >
                    <div class="invalid-feedback">Room type is required.</div>
                  </div>

                  <!-- If Shared: Number of people allowed plus sharing allowed toggle -->
                  <div
                    id="sharedRoomExtras"
                    class="ml-3 border rounded p-3 bg-light"
                    style="display: none;"
                  >
                    <div class="form-group">
                      <label for="peopleAllowed">How many people allowed? <span class="text-danger">*</span></label>
                      <input
                        type="number"
                        id="peopleAllowed"
                        class="form-control"
                        min="1"
                        max="10"
                        placeholder="e.g., 2"
                      />
                      <div class="invalid-feedback" id="peopleAllowedFeedback">
                        Please enter a value between 1 and 10.
                      </div>
                    </div>
                    <div class="form-group">
                      <label for="isSharingAllowedToggle"
                        >Is Sharing Allowed? <span class="text-danger">*</span></label
                      ><br />
                      <input
                        type="checkbox"
                        id="isSharingAllowedToggle"
                        role="switch"
                        aria-checked="false"
                      />
                      <small class="form-text text-muted"
                        >Allow other tenants to post roommate listings.</small
                      >
                      <div class="invalid-feedback" id="sharingAllowedFeedback">
                        Sharing allowed must be specified for shared room.
                      </div>
                    </div>
                  </div>

                  <!-- Number of Beds -->
                  <div class="form-group">
                    <label for="numberOfBeds"
                      >Number of Beds <span class="text-danger">*</span></label
                    >
                    <input
                      type="number"
                      id="numberOfBeds"
                      class="form-control"
                      min="1"
                      max="10"
                      required
                      placeholder="1"
                    />
                    <div class="invalid-feedback">
                      Enter number of beds between 1 and 10.
                    </div>
                  </div>

                  <!-- Room Size -->
                  <div class="form-group">
                    <label for="roomSize">Room Size (Optional)</label>
                    <input
                      type="text"
                      class="form-control"
                      id="roomSize"
                      placeholder="Example: 120 Sq. Ft. or 10x12 Feet"
                      maxlength="20"
                    />
                  </div>

                  <!-- Furnishing Type -->
                  <div class="form-group">
                    <label>Furnishing Type <span class="text-danger">*</span></label>
                    <div>
                      <div class="form-check form-check-inline">
                        <input
                          class="form-check-input"
                          type="radio"
                          name="furnishingType"
                          id="fullyFurnished"
                          value="Fully Furnished"
                          required
                        />
                        <label class="form-check-label" for="fullyFurnished"
                          >Fully Furnished</label
                        >
                      </div>
                      <div class="form-check form-check-inline">
                        <input
                          class="form-check-input"
                          type="radio"
                          name="furnishingType"
                          id="semiFurnished"
                          value="Semi Furnished"
                        />
                        <label class="form-check-label" for="semiFurnished"
                          >Semi Furnished</label
                        >
                      </div>
                      <div class="form-check form-check-inline">
                        <input
                          class="form-check-input"
                          type="radio"
                          name="furnishingType"
                          id="unfurnished"
                          value="Unfurnished"
                        />
                        <label class="form-check-label" for="unfurnished"
                          >Unfurnished</label
                        >
                      </div>
                      <div class="invalid-feedback d-block furnishFeedback" style="display:none;">
                        Furnishing type is required.
                      </div>
                    </div>
                  </div>

                  <div class="float-right">
                    <button type="button" class="btn btn-primary btn-step" id="toStep2">
                      Next
                    </button>
                  </div>
                </div>

                <!-- Step 2: Title, Description and Rent -->
                <div class="step" data-step="2" aria-label="Step 2">
                  <h5 class="mb-4">Step 2: Title, Description & Rent</h5>

                  <!-- Room Title -->
                  <div class="form-group">
                    <label for="roomTitle"
                      >Room Title <span class="text-danger">*</span></label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="roomTitle"
                      maxlength="100"
                      placeholder='e.g. "Furnished 1BHK near XYZ College"'
                      required
                      aria-describedby="roomTitleHelp"
                    />
                    <small id="roomTitleHelp" class="form-text text-muted"
                      >Short title; auto-suggest enabled.</small
                    >
                    <div class="invalid-feedback">
                      Room title is required (max 100 characters).
                    </div>
                  </div>

                  <!-- Room Description -->
                  <div class="form-group">
                    <label for="roomDescription"
                      >Room Description <span class="text-danger">*</span></label
                    >
                    <textarea
                      class="form-control"
                      id="roomDescription"
                      rows="5"
                      minlength="50"
                      maxlength="2000"
                      placeholder="Describe room, locality, amenities, water availability, etc."
                      required
                    ></textarea>
                    <div class="invalid-feedback">
                      Description must be between 50 and 2000 characters.
                    </div>
                  </div>

                  <!-- Monthly Rent -->
                  <div class="form-group">
                    <label for="monthlyRent"
                      >Monthly Rent (₹) <span class="text-danger">*</span></label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="monthlyRent"
                      min="500"
                      required
                      placeholder="Minimum ₹500"
                    />
                    <div class="invalid-feedback">Enter rent ₹500 or more.</div>
                  </div>

                  <!-- Rent per Person (for Shared) -->
                  <div
                    class="form-group"
                    id="rentPerPersonContainer"
                    style="display:none;"
                  >
                    <label for="rentPerPerson">Rent Per Person (₹)</label>
                    <input
                      type="number"
                      id="rentPerPerson"
                      class="form-control"
                      min="0"
                      placeholder="Optional for shared room"
                    />
                  </div>

                  <!-- Security Deposit -->
                  <div class="form-group">
                    <label for="securityDeposit">Security Deposit (Optional)</label>
                    <input
                      type="number"
                      class="form-control"
                      id="securityDeposit"
                      min="0"
                      placeholder="One-time refundable amount"
                    />
                    <small
                      class="form-text text-muted"
                      id="securityDepositLabel"
                      style="display:none;"
                      >Refundable on terms</small
                    >
                  </div>

                  <div class="float-left">
                    <button type="button" class="btn btn-secondary btn-step" id="backTo1">
                      Back
                    </button>
                  </div>
                  <div class="float-right">
                    <button type="button" id="toStep3" class="btn btn-primary btn-step">
                      Next
                    </button>
                  </div>
                </div>

                <!-- Step 3: Photos and Amenities -->
                <div class="step" data-step="3" aria-label="Step 3">
                  <h5 class="mb-4">Step 3: Photos & Amenities</h5>

                  <!-- Photos -->
                  <div class="form-group">
                    <label for="photos"
                      >Upload Photos <span class="text-danger">*</span></label
                    >
                    <input
                      type="file"
                      id="photos"
                      accept=".jpg,.jpeg,.png,.webp"
                      multiple
                      required
                      aria-describedby="photoHelp"
                    />
                    <small id="photoHelp" class="form-text text-muted">
                      Minimum 3, Maximum 10 photos.<br />
                      JPG, PNG, WebP formats only. Max size: 2MB each.
                    </small>
                    <div class="invalid-feedback" id="photoError" style="display:none;">
                      Please upload between 3 and 10 photos. Each must be ≤ 2MB and JPG, PNG, or WebP.
                    </div>
                    <div id="photoPreview" aria-live="polite"></div>
                  </div>

                  <!-- Amenities -->
                  <div class="form-group">
                    <label>Amenities (at least one preferred)</label>
                    <div class="row">
                      <div class="col-md-4">
                        <div class="form-check" title="Wireless Internet">
                          <input
                            class="form-check-input amenity-checkbox"
                            type="checkbox"
                            id="wifi"
                          />
                          <label class="form-check-label" for="wifi">Wi-Fi</label>
                        </div>
                        <div class="form-check" title="Air Conditioning">
                          <input
                            class="form-check-input amenity-checkbox"
                            type="checkbox"
                            id="ac"
                          />
                          <label class="form-check-label" for="ac"
                            >Air Conditioning</label
                          >
                        </div>
                        <div class="form-check" title="Private attached bathroom">
                          <input
                            class="form-check-input amenity-checkbox"
                            type="checkbox"
                            id="attachedBathroom"
                          />
                          <label class="form-check-label" for="attachedBathroom"
                            >Attached Bathroom</label
                          >
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="form-check" title="Shared bathroom">
                          <input
                            class="form-check-input amenity-checkbox"
                            type="checkbox"
                            id="sharedBathroom"
                          />
                          <label class="form-check-label" for="sharedBathroom"
                            >Shared Bathroom</label
                          >
                        </div>
                        <div class="form-check" title="Access to kitchen">
                          <input
                            class="form-check-input amenity-checkbox"
                            type="checkbox"
                            id="kitchenAccess"
                          />
                          <label class="form-check-label" for="kitchenAccess"
                            >Kitchen Access</label
                          >
                        </div>
                        <div class="form-check" title="Refrigerator access">
                          <input
                            class="form-check-input amenity-checkbox"
                            type="checkbox"
                            id="refrigerator"
                          />
                          <label class="form-check-label" for="refrigerator"
                            >Refrigerator</label
                          >
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="form-check" title="Washing Machine">
                          <input
                            class="form-check-input amenity-checkbox"
                            type="checkbox"
                            id="washingMachine"
                          />
                          <label class="form-check-label" for="washingMachine"
                            >Washing Machine</label
                          >
                        </div>
                        <div class="form-check" title="Geyser / Water Heater">
                          <input
                            class="form-check-input amenity-checkbox"
                            type="checkbox"
                            id="geyser"
                          />
                          <label class="form-check-label" for="geyser">Geyser</label>
                        </div>
                        <div class="form-check" title="Power Backup">
                          <input
                            class="form-check-input amenity-checkbox"
                            type="checkbox"
                            id="powerBackup"
                          />
                          <label class="form-check-label" for="powerBackup"
                            >Power Backup</label
                          >
                        </div>
                        <div class="form-check" title="CCTV Cameras">
                          <input
                            class="form-check-input amenity-checkbox"
                            type="checkbox"
                            id="cctv"
                          />
                          <label class="form-check-label" for="cctv">CCTV</label>
                        </div>
                        <div class="form-check" title="Lift / Elevator">
                          <input
                            class="form-check-input amenity-checkbox"
                            type="checkbox"
                            id="lift"
                          />
                          <label class="form-check-label" for="lift">Lift</label>
                        </div>
                        <div class="form-check" title="Balcony">
                          <input
                            class="form-check-input amenity-checkbox"
                            type="checkbox"
                            id="balcony"
                          />
                          <label class="form-check-label" for="balcony">Balcony</label>
                        </div>
                        <div class="form-check" title="Parking Available">
                          <input
                            class="form-check-input amenity-checkbox"
                            type="checkbox"
                            id="parking"
                          />
                          <label class="form-check-label" for="parking">Parking</label>
                        </div>
                        <div class="form-check" title="Drinking Water (RO)">
                          <input
                            class="form-check-input amenity-checkbox"
                            type="checkbox"
                            id="drinkingWater"
                          />
                          <label class="form-check-label" for="drinkingWater"
                            >Drinking Water (RO)</label
                          >
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="float-left">
                    <button type="button" class="btn btn-secondary btn-step" id="backTo2">
                      Back
                    </button>
                  </div>
                  <div class="float-right">
                    <button type="button" id="toStep4" class="btn btn-primary btn-step">
                      Next
                    </button>
                  </div>
                </div>

                <!-- Step 4: Rules and Tenant -->
                <div class="step" data-step="4" aria-label="Step 4">
                  <h5 class="mb-4">Step 4: Rules & Preferred Tenants</h5>

                  <!-- Rules / Restrictions -->
                  <div class="form-group">
                    <label>Rules / Restrictions</label>
                    <div class="row">
                      <div class="col-md-4">
                        <div class="form-check" title="Smoking Allowed?">
                          <input
                            class="form-check-input rule-checkbox"
                            type="checkbox"
                            id="smokingAllowed"
                          />
                          <label class="form-check-label" for="smokingAllowed"
                            >Smoking Allowed?</label
                          >
                        </div>
                        <div class="form-check" title="Alcohol Allowed?">
                          <input
                            class="form-check-input rule-checkbox"
                            type="checkbox"
                            id="alcoholAllowed"
                          />
                          <label class="form-check-label" for="alcoholAllowed"
                            >Alcohol Allowed?</label
                          >
                        </div>
                        <div class="form-check" title="Pets Allowed?">
                          <input
                            class="form-check-input rule-checkbox"
                            type="checkbox"
                            id="petsAllowed"
                          />
                          <label class="form-check-label" for="petsAllowed"
                            >Pets Allowed?</label
                          >
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="form-check" title="Opposite Gender Allowed?">
                          <input
                            class="form-check-input rule-checkbox"
                            type="checkbox"
                            id="oppositeGenderAllowed"
                          />
                          <label class="form-check-label" for="oppositeGenderAllowed"
                            >Opposite Gender Allowed?</label
                          >
                        </div>
                        <div class="form-check" title="Visitor Entry Allowed?">
                          <input
                            class="form-check-input rule-checkbox"
                            type="checkbox"
                            id="visitorEntryAllowed"
                          />
                          <label class="form-check-label" for="visitorEntryAllowed"
                            >Visitor Entry Allowed?</label
                          >
                        </div>
                        <div class="form-check" title="Loud Music Allowed?">
                          <input
                            class="form-check-input rule-checkbox"
                            type="checkbox"
                            id="loudMusicAllowed"
                          />
                          <label class="form-check-label" for="loudMusicAllowed"
                            >Loud Music Allowed?</label
                          >
                        </div>
                        <div class="form-check" title="Cooking Allowed?">
                          <input
                            class="form-check-input rule-checkbox"
                            type="checkbox"
                            id="cookingAllowed"
                          />
                          <label class="form-check-label" for="cookingAllowed"
                            >Cooking Allowed?</label
                          >
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Preferred Tenant -->
                  <div class="form-group">
                    <label>Preferred Tenant Type</label>
                    <select
                      class="form-control"
                      id="preferredTenant"
                      multiple
                      size="5"
                      aria-describedby="preferredTenantHelp"
                    >
                      <option value="student">Student</option>
                      <option value="workingProfessional">Working Professional</option>
                      <option value="maleOnly">Male Only</option>
                      <option value="femaleOnly">Female Only</option>
                      <option value="coupleAllowed">Couple Allowed</option>
                    </select>
                    <small id="preferredTenantHelp" class="form-text text-muted"
                      >Select one or more preferred tenant types.</small
                    >
                  </div>

                  <div class="float-left">
                    <button type="button" class="btn btn-secondary btn-step" id="backTo3">
                      Back
                    </button>
                  </div>
                  <div class="float-right">
                    <button type="button" id="toStep5" class="btn btn-primary btn-step">
                      Next
                    </button>
                  </div>
                </div>

                <!-- Step 5: Availability and Location -->
                <div class="step" data-step="5" aria-label="Step 5">
                  <h5 class="mb-4">Step 5: Availability & Location</h5>

                  <!-- Available From -->
                  <div class="form-group">
                    <label for="availableFrom">Available From</label>
                    <input
                      type="date"
                      class="form-control"
                      id="availableFrom"
                      aria-describedby="availableFromHelp"
                    />
                    <small id="availableFromHelp" class="form-text text-muted"
                      >Select available date for booking system synchronization.</small
                    >
                  </div>

                  <!-- Minimum Stay Duration -->
                  <div class="form-group">
                    <label for="minimumStayDuration">Minimum Stay Duration</label>
                    <select
                      class="form-control"
                      id="minimumStayDuration"
                      aria-describedby="minimumStayHelp"
                    >
                      <option value="noMinimum">No Minimum</option>
                      <option value="1Month">1 Month</option>
                      <option value="3Months">3 Months</option>
                      <option value="6Months">6 Months</option>
                    </select>
                    <small id="minimumStayHelp" class="form-text text-muted"
                      >Choose minimum stay duration.</small
                    >
                  </div>

                  <!-- Address Fields -->
                  <fieldset class="border p-3 mb-3">
                    <legend class="w-auto px-2">Address (Manual Entry)</legend>
                    <div class="form-group">
                      <label for="houseNumber">House Number</label>
                      <input
                        type="text"
                        id="houseNumber"
                        class="form-control"
                        maxlength="50"
                        placeholder="House Number"
                      />
                    </div>
                    <div class="form-group">
                      <label for="streetLocality">Street / Locality</label>
                      <input
                        type="text"
                        id="streetLocality"
                        class="form-control"
                        maxlength="100"
                        placeholder="Street / Locality"
                      />
                    </div>
                    <div class="form-group">
                      <label for="landmark">Landmark</label>
                      <input
                        type="text"
                        id="landmark"
                        class="form-control"
                        maxlength="100"
                        placeholder="Landmark"
                      />
                    </div>
                    <div class="form-group">
                      <label for="city">City</label>
                      <input
                        type="text"
                        id="city"
                        class="form-control"
                        maxlength="50"
                        placeholder="City"
                      />
                    </div>
                    <div class="form-group">
                      <label for="pincode">Pincode</label>
                      <input
                        type="text"
                        id="pincode"
                        class="form-control"
                        maxlength="10"
                        pattern="[0-9]{6}"
                        placeholder="Pincode (6 digit)"
                      />
                      <small class="form-text text-muted">
                        6 digit postal code (numeric only).
                      </small>
                    </div>
                    <div class="form-group">
                      <label for="state">State</label>
                      <input
                        type="text"
                        id="state"
                        class="form-control"
                        maxlength="50"
                        placeholder="State"
                      />
                    </div>
                  </fieldset>

                  <!-- Map Location -->
                  <div class="form-group">
                    <label for="mapLocation">Map Location (Pin Drop / Detect)</label>
                    <div>
                      <button
                        type="button"
                        class="btn btn-info btn-sm mb-2"
                        id="detectLocationBtn"
                      >
                        Detect My Location
                      </button>
                    </div>
                    <div id="map" style="height: 300px; border: 1px solid #ccc;"></div>
                    <input type="hidden" id="mapLatitude" />
                    <input type="hidden" id="mapLongitude" />
                  </div>

                  <div class="float-left">
                    <button type="button" class="btn btn-secondary btn-step" id="backTo4">
                      Back
                    </button>
                  </div>
                  <div class="float-right">
                    <button type="submit" class="btn btn-success btn-step" id="submitBtn">
                      Submit Listing
                    </button>
                  </div>
                  <div id="formMessage" role="alert" aria-live="assertive"></div>
                </div>

              </div>
            </div>
          </form>
        </div>
      </section>
    </div>
  </div>

  <!-- Scripts -->
  <script
    src="https://code.jquery.com/jquery-3.6.0.min.js"
    crossorigin="anonymous"
  ></script>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.1.0/js/adminlte.min.js"
    crossorigin="anonymous"
  ></script>
  <script
    src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
    crossorigin=""
  ></script>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    crossorigin=""
  />
  <script>
    $(function () {
      // Initialize variables for steps
      let currentStep = 1;
      const totalSteps = 5;
      const form = $("#roomListingForm");
      const photoInput = $("#photos");
      const photoPreview = $("#photoPreview");
      const formMessage = $("#formMessage");
      const furnishingRadios = $('input[name="furnishingType"]');

      // Show/hide shared room extras based on roomType select
      function updateSharedRoomFields() {
        const roomType = $("#roomType").val();
        if (roomType === "shared") {
          $("#sharedRoomExtras").show();
          $("#peopleAllowed").attr("required", true);
          $("#isSharingAllowedToggle").attr("required", true);
          $("#rentPerPersonContainer").show();
        } else {
          $("#sharedRoomExtras").hide();
          $("#peopleAllowed").removeAttr("required");
          $("#isSharingAllowedToggle").removeAttr("required");
          $("#rentPerPersonContainer").hide();
        }
      }

      // Auto suggest title from room type, furnishing, and locality
      function autoSuggestTitle() {
        let firType = $("#roomType").val();
        let furnish = $('input[name="furnishingType"]:checked').val();
        let locality = $("#streetLocality").val().trim();
        let size = $("#roomSize").val().trim();

        if (!firType || !furnish) {
          return;
        }
        let titleParts = [];
        if (furnish) titleParts.push(furnish);
        if (size) titleParts.push(size);
        titleParts.push(firType === "shared" ? "Shared Room" : "Private Room");
        if (locality) titleParts.push("near " + locality);
        let suggested = titleParts.join(" ");
        let roomTitleInput = $("#roomTitle");
        if (roomTitleInput.val().trim() === "" || roomTitleInput.data("auto-filled")) {
          roomTitleInput.val(suggested);
          roomTitleInput.data("auto-filled", true);
        }
      }

      // Validate photo files (extension, size, number)
      function validatePhotos(files) {
        const allowedTypes = ["image/jpeg", "image/png", "image/webp"];
        if (files.length < 3 || files.length > 10) {
          return false;
        }
        for (let f of files) {
          if (!allowedTypes.includes(f.type)) return false;
          if (f.size > 2 * 1024 * 1024) return false; // >2MB
        }
        return true;
      }

      // Show photo thumbnails preview
      function previewPhotos(files) {
        photoPreview.empty();
        if (!files || files.length === 0) return;
        Array.from(files).forEach((file) => {
          if (!file.type.startsWith("image/")) return;
          let img = document.createElement("img");
          img.src = URL.createObjectURL(file);
          img.alt = file.name;
          img.onload = function () {
            URL.revokeObjectURL(this.src);
          };
          photoPreview.append(img);
        });
      }

      // Save form data (except files) to localStorage on change
      function saveToDraft() {
        let formData = {};
        form.serializeArray().forEach(pair => {
          formData[pair.name] = pair.value;
        });
        // Save checkbox/radio manually (some are outside serializedArray)
        formData["peopleAllowed"] = $("#peopleAllowed").val();
        formData["isSharingAllowedToggle"] = $("#isSharingAllowedToggle").is(":checked");
        formData["securityDeposit"] = $("#securityDeposit").val();
        formData["preferredTenant"] = $("#preferredTenant").val();
        formData["furnishingType"] = $("input[name='furnishingType']:checked").val();
        formData["amenities"] = [];
        $(".amenity-checkbox:checked").each(function () {
          formData["amenities"].push(this.id);
        });
        formData["rules"] = [];
        $(".rule-checkbox:checked").each(function () {
          formData["rules"].push(this.id);
        });
        // Save to localStorage as JSON string
        localStorage.setItem("roomListingDraft", JSON.stringify(formData));
      }

      // Load draft data from localStorage
      function loadDraft() {
        let draft = localStorage.getItem("roomListingDraft");
        if (!draft) return;
        let formData = JSON.parse(draft);
        if (!formData) return;
        // Load values
        $("#roomType").val(formData.roomType || "");
        $("#peopleAllowed").val(formData.peopleAllowed || "");
        $("#isSharingAllowedToggle").prop("checked", formData.isSharingAllowedToggle || false);
        $("#numberOfBeds").val(formData.numberOfBeds || "");
        $("#roomSize").val(formData.roomSize || "");
        $("#roomTitle").val(formData.roomTitle || "");
        $("#roomDescription").val(formData.roomDescription || "");
        $("#monthlyRent").val(formData.monthlyRent || "");
        $("#rentPerPerson").val(formData.rentPerPerson || "");
        $("#securityDeposit").val(formData.securityDeposit || "");
        if (formData.furnishingType) {
          $(`input[name='furnishingType'][value='${formData.furnishingType}']`).prop("checked", true);
        }
        if (formData.preferredTenant && Array.isArray(formData.preferredTenant)) {
          $("#preferredTenant").val(formData.preferredTenant);
        }
        if (formData.amenities && Array.isArray(formData.amenities)) {
          $(".amenity-checkbox").prop("checked", false);
          formData.amenities.forEach((id) => {
            $(`#${id}`).prop("checked", true);
          });
        }
        if (formData.rules && Array.isArray(formData.rules)) {
          $(".rule-checkbox").prop("checked", false);
          formData.rules.forEach((id) => {
            $(`#${id}`).prop("checked", true);
          });
        }
        // Address fields separately (if you add ids)
        $("#houseNumber").val(formData.houseNumber || "");
        $("#streetLocality").val(formData.streetLocality || "");
        $("#landmark").val(formData.landmark || "");
        $("#city").val(formData.city || "");
        $("#pincode").val(formData.pincode || "");
        $("#state").val(formData.state || "");
        $("#availableFrom").val(formData.availableFrom || "");
        $("#minimumStayDuration").val(formData.minimumStayDuration || "noMinimum");
      }

      // Validate current step fields: returns true if valid, else false
      function validateStep(step) {
        let valid = true;
        formMessage.text("");

        if(step === 1) {
          // Room Type required
          let roomType = $("#roomType").val();
          if (!roomType) {
            $("#roomType")[0].classList.add("is-invalid");
            valid = false;
          } else {
            $("#roomType")[0].classList.remove("is-invalid");
          }

          // If shared, check peopleAllowed and isSharingAllowedToggle required
          if(roomType === "shared") {
            let peopleVal = $("#peopleAllowed").val();
            if (!peopleVal || peopleVal < 1 || peopleVal > 10) {
              $("#peopleAllowed").addClass("is-invalid");
              valid = false;
            } else {
              $("#peopleAllowed").removeClass("is-invalid");
            }
            if(!$("#isSharingAllowedToggle").is(":checked")) {
              $("#isSharingAllowedToggle").addClass("is-invalid");
              valid = false;
            } else {
              $("#isSharingAllowedToggle").removeClass("is-invalid");
            }
          }

          // Validate Number of Beds
          let bedsVal = $("#numberOfBeds").val();
          if(!bedsVal || bedsVal < 1 || bedsVal > 10) {
            $("#numberOfBeds").addClass("is-invalid");
            valid = false;
          } else {
            $("#numberOfBeds").removeClass("is-invalid");
          }

          // Furnishing Type required check
          if(!$('input[name="furnishingType"]:checked').length) {
            $(".furnishFeedback").show();
            valid = false;
          } else {
            $(".furnishFeedback").hide();
          }
        }
        else if(step === 2) {
          // Room Title required max 100 chars
          let title = $("#roomTitle").val().trim();
          if(!title || title.length > 100) {
            $("#roomTitle")[0].classList.add("is-invalid");
            valid = false;
          } else {
            $("#roomTitle")[0].classList.remove("is-invalid");
          }
          // Description min 50 max 2000 chars
          let desc = $("#roomDescription").val().trim();
          if(desc.length < 50 || desc.length > 2000) {
            $("#roomDescription")[0].classList.add("is-invalid");
            valid = false;
          } else {
            $("#roomDescription")[0].classList.remove("is-invalid");
          }
          // Monthly Rent min 500
          let rent = $("#monthlyRent").val();
          if(!rent || rent < 500) {
            $("#monthlyRent").addClass("is-invalid");
            valid = false;
          } else {
            $("#monthlyRent").removeClass("is-invalid");
          }
        }
        else if(step === 3) {
          // Photos validation
          let files = photoInput[0].files;
          if(!validatePhotos(files)){
            $("#photoError").show();
            photoInput.addClass("is-invalid");
            valid = false;
          } else {
            $("#photoError").hide();
            photoInput.removeClass("is-invalid");
          }
          // At least 1 amenity preferred (not required but preferred)
          // no mandatory validation on amenities
        }
        // Steps 4 and 5 have no mandatory validations except preferred furnishing and room type earlier
        return valid;
      }

      // Show step and hide others
      function showStep(step) {
        $(".step").removeClass("active");
        $(`.step[data-step="${step}"]`).addClass("active");
        currentStep = step;
        updateSharedRoomFields();
        autoSuggestTitle();
      }

      // Next and Back button handlers
      $("#toStep2").click(function () {
        if(!validateStep(1)) return;
        showStep(2);
      });
      $("#backTo1").click(function () {
        showStep(1);
      });
      $("#toStep3").click(function () {
        if(!validateStep(2)) return;
        showStep(3);
      });
      $("#backTo2").click(function () {
        showStep(2);
      });
      $("#toStep4").click(function () {
        if(!validateStep(3)) return;
        showStep(4);
      });
      $("#backTo3").click(function () {
        showStep(3);
      });
      $("#toStep5").click(function () {
        // No validation on step 4 currently
        showStep(5);
      });
      $("#backTo4").click(function () {
        showStep(4);
      });

      // Toggle fields when roomType changes
      $("#roomType").change(function () {
        updateSharedRoomFields();
        autoSuggestTitle();
      });
      furnishingRadios.change(function () {
        autoSuggestTitle();
      });
      $("#streetLocality, #roomSize").on("input", function() {
        autoSuggestTitle();
      });

      // Rent per person toggle
      $("#roomType").change(function () {
        if ($(this).val() === "shared") {
          $("#rentPerPersonContainer").show();
        } else {
          $("#rentPerPersonContainer").hide();
          $("#rentPerPerson").val("");
        }
      });

      // Show refundable label on security deposit entered
      $("#securityDeposit").on("input", function () {
        if ($(this).val() && Number($(this).val()) > 0) {
          $("#securityDepositLabel").show();
        } else {
          $("#securityDepositLabel").hide();
        }
      });

      // Photo input change preview and validate
      photoInput.change(function () {
        let files = this.files;
        if (validatePhotos(files)) {
          previewPhotos(files);
          $("#photoError").hide();
          photoInput.removeClass("is-invalid");
        } else {
          photoPreview.empty();
          $("#photoError").show();
          photoInput.addClass("is-invalid");
        }
      });

      // Detect location functionality using Leaflet and Geolocation API
      let map = L.map("map").setView([20.5937, 78.9629], 5); // Default India center
      let marker = null;

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      }).addTo(map);

      function setMarker(lat, lng) {
        if (marker) {
          marker.setLatLng([lat, lng]);
        } else {
          marker = L.marker([lat, lng], {draggable: true}).addTo(map);
          marker.on("dragend", function () {
            let pos = marker.getLatLng();
            $("#mapLatitude").val(pos.lat.toFixed(6));
            $("#mapLongitude").val(pos.lng.toFixed(6));
          });
        }
        map.setView([lat, lng], 15);
        $("#mapLatitude").val(lat.toFixed(6));
        $("#mapLongitude").val(lng.toFixed(6));
      }

      $("#detectLocationBtn").click(function () {
        if (!navigator.geolocation) {
          alert("Geolocation is not supported by your browser.");
          return;
        }
        $(this).prop("disabled", true).text("Detecting...");
        navigator.geolocation.getCurrentPosition(
          function (position) {
            setMarker(position.coords.latitude, position.coords.longitude);
            $("#detectLocationBtn").prop("disabled", false).text("Detect My Location");
          },
          function () {
            alert("Unable to retrieve your location.");
            $("#detectLocationBtn").prop("disabled", false).text("Detect My Location");
          }
        );
      });

      // On map click, drop/move marker
      map.on("click", function (e) {
        setMarker(e.latlng.lat, e.latlng.lng);
      });

      // Form submission handler
      form.on("submit", function (e) {
        e.preventDefault();
        // Validate all steps before submission
        let validAll =
          validateStep(1) &&
          validateStep(2) &&
          validateStep(3);
        if (!validAll) {
          formMessage.text(
            "Please correct errors in the form before submitting."
          );
          // navigate user to first invalid step
          if(!validateStep(1)) showStep(1);
          else if(!validateStep(2)) showStep(2);
          else showStep(3);
          return;
        }
        formMessage.text("");
        // Since there's no backend, we'll just show submission success
        alert("Your room listing has been successfully submitted!");
        // Clear localStorage
        localStorage.removeItem("roomListingDraft");
        form[0].reset();
        photoPreview.empty();
        showStep(1);
      });

      // Auto save draft in localStorage every 3 seconds if form changed
      let saveTimeout = null;
      form.on("input change", function () {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(saveToDraft, 3000);
      });

      // On load, load draft if any
      loadDraft();
      updateSharedRoomFields();

    }); // end jQuery ready
  </script>
</body>
</html>
